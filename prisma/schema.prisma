// uBee Furniture — Client Intelligence Database
// Prisma + Supabase (Postgres)
// Sales pipeline, client scoring, AI-ready recommendations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────────────────

enum ClientType {
  LANDLORD
  LETTING_AGENT
  SOCIAL_HOUSING
  RETAIL
}

enum VolumeTier {
  MICRO       // 1–5 units
  SMALL       // 6–20 units
  MEDIUM      // 21–50 units
  LARGE       // 51–200 units
  ENTERPRISE  // 200+ units
}

enum BudgetBand {
  BUDGET
  STANDARD
  PREMIUM
}

enum UrgencyLevel {
  IMMEDIATE
  URGENT
  NORMAL
  PLANNED
}

enum ComplianceRequirement {
  NONE
  CRIB5
  FIRE_SAFETY
  FULL_COMPLIANCE
}

enum RelationshipStage {
  PROSPECT
  LEAD
  QUALIFIED
  ACTIVE
  CHURNED
  LAPSED
}

enum DealStage {
  DISCOVERY
  QUOTE_SENT
  NEGOTIATION
  WON
  LOST
}

enum DealSource {
  WEBSITE
  REFERRAL
  COLD_OUTREACH
  TRADE_SHOW
  PARTNERSHIP
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum PropertyType {
  FLAT
  HOUSE
  HMO
  HOSTEL
  OTHER
}

enum PropertyStatus {
  VACANT
  TENANTED
  REFURBISHMENT
  NEW_BUILD
}

enum InteractionType {
  CALL
  WHATSAPP
  EMAIL
  MEETING
}

enum MarkupType {
  PERCENT
  FIXED
}

// ─────────────────────────────────────────────────────────────────────────────
// MODELS
// ─────────────────────────────────────────────────────────────────────────────

model Client {
  id                    String    @id @default(cuid())
  clientType            ClientType
  volumeTier            VolumeTier
  budgetBand            BudgetBand
  urgencyLevel          UrgencyLevel
  complianceRequirement ComplianceRequirement
  relationshipStage     RelationshipStage
  region                String?
  companyName           String?
  displayName           String?

  // Pipeline
  estimatedAnnualValue  Int?
  probability           Int?     // 0–100
  nextAction            String?
  nextActionDate        DateTime?
  assignedTo            String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contacts     ClientContact[]
  properties   Property[]
  deals        Deal[]
  quotes       Quote[]
  orders       Order[]
  interactions Interaction[]
  metrics      ClientMetrics?
  recommendations Recommendation[]

  @@index([clientType])
  @@index([region])
}

model ClientContact {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  role      String?
  isPrimary Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

model Property {
  id             String         @id @default(cuid())
  clientId       String
  client         Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  propertyType   PropertyType
  propertyStatus PropertyStatus
  postcodeArea   String?
  addressLine1   String?
  addressLine2   String?
  unitCount      Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deals  Deal[]
  quotes Quote[]

  @@index([clientId])
  @@index([postcodeArea])
}

model Deal {
  id           String     @id @default(cuid())
  clientId     String
  client       Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  propertyId   String?
  property     Property?  @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  stage        DealStage
  source       DealSource
  value        Decimal?   @db.Decimal(10, 2)
  nextActionAt DateTime?
  notes        String?    @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quotes Quote[]
  orders Order[]

  @@index([clientId])
  @@index([stage])
  @@index([nextActionAt])
}

model Quote {
  id         String   @id @default(cuid())
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  dealId     String?
  deal       Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  total      Decimal  @db.Decimal(10, 2)
  validUntil DateTime?
  status     String   @default("draft") // draft, sent, accepted, expired

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([dealId])
}

model Order {
  id           String   @id @default(cuid())
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dealId       String?
  deal         Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  shopifyId    String?  // Link to Shopify order
  total        Decimal  @db.Decimal(10, 2)
  paymentTerms String?  // e.g. "Net 30", "Immediate"
  paidAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([createdAt])
}

model Package {
  id          String   @id @default(cuid())
  shopifyId   String?  // Shopify product ID
  name        String
  slug        String   @unique
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  isCrib5     Boolean  @default(false)
  isExpress   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isCrib5])
  @@index([isExpress])
}

model Interaction {
  id        String         @id @default(cuid())
  clientId  String
  client    Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  type      InteractionType
  summary   String?        @db.Text
  direction String?        // inbound, outbound

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([createdAt])
}

model ClientMetrics {
  id            String   @id @default(cuid())
  clientId      String   @unique
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  opportunityScore Int?
  riskScore     Int?
  aov           Decimal? @db.Decimal(10, 2)
  totalOrders   Int      @default(0)
  totalValue    Decimal  @default(0) @db.Decimal(12, 2)
  lastOrderAt   DateTime?
  latePaymentsCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([opportunityScore])
  @@index([riskScore])
}

model Recommendation {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ruleType  String   // e.g. "CRIB5_ELIGIBLE", "EXPRESS_OFFER", "STANDARD_PACKAGE"
  text      String   @db.Text
  priority  Int      @default(0)
  metadata  Json?    // e.g. { packageId, badge }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([ruleType])
}

model Agent {
  id                  String            @id @default(uuid())
  name                String
  agencyName          String            @map("agency_name")
  email               String            @unique
  phone               String?
  brandingLogoUrl     String?           @map("branding_logo_url")
  brandingPrimaryColor String?          @map("branding_primary_color")
  markupType          MarkupType        @default(PERCENT) @map("markup_type")
  markupValue         Decimal           @default(0) @db.Decimal(10, 2) @map("markup_value")
  createdAt           DateTime          @default(now()) @map("created_at")

  catalogues          AgentCatalogue[]
  accessTokens        AgentAccessToken[]
  enquiries           Enquiry[]

  @@map("agents")
}

model AgentCatalogue {
  id         String   @id @default(uuid())
  agentId    String   @map("agent_id")
  slug       String   @unique
  title      String
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  enquiries  Enquiry[]

  @@index([agentId])
  @@map("agent_catalogues")
}

model AgentAccessToken {
  id         String   @id @default(uuid())
  agentId    String   @map("agent_id")
  token      String   @unique
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  agent      Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@map("agent_access_tokens")
}

model Lead {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now()) @map("created_at")
  name       String
  agencyName String?  @map("agency_name")
  email      String
  phone      String?
  volume     String?
  notes      String?  @db.Text
  source     String?

  @@index([email])
  @@map("leads")
}

model Enquiry {
  id              String         @id @default(uuid())
  createdAt       DateTime       @default(now()) @map("created_at")
  agentId         String         @map("agent_id")
  catalogueId     String         @map("catalogue_id")
  customerName    String         @map("customer_name")
  customerEmail   String         @map("customer_email")
  propertyAddress String         @map("property_address")
  itemsInterestedIn String       @map("items_interested_in")
  message         String?        @db.Text
  status          String         @default("NEW")

  agent           Agent          @relation(fields: [agentId], references: [id], onDelete: Cascade)
  catalogue       AgentCatalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([catalogueId])
  @@index([status])
  @@map("enquiries")
}

model CatalogueLead {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  name      String
  email     String
  role      String
  source    String?

  @@index([email])
  @@map("catalogue_leads")
}

// ─────────────────────────────────────────────────────────────────────────────
// SUPPLIER FEEDS (e.g. FTG)
// ─────────────────────────────────────────────────────────────────────────────

model SupplierProduct {
  id                 String   @id @default(cuid())
  supplier           String   // e.g. "FTG"
  sku                String
  productId          String?  // FTG product ID
  shopifyProductId   String?  // Shopify GID after sync (e.g. gid://shopify/Product/123)
  ean                String?
  commodityCode  String?
  range          String?
  name           String?  @db.Text
  description    String?  @db.Text
  finish         String?

  // Assembled dimensions (stored as JSON: { widthCm, heightCm, depthCm, weightKg })
  assembledJson  Json?

  // Boxes (array of { boxIndex, ean, lengthCm, widthCm, heightCm, m3, weightKg })
  boxesJson      Json?

  // Image URLs (array of strings)
  imagesJson     Json?    // string[]

  // Category flags C1..C19 (object of booleans)
  categoriesJson Json?

  // Compliance URLs
  frFabricUrl    String?  @db.Text
  frFoamUrl      String?  @db.Text

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([supplier, sku])
  @@index([supplier])
  @@index([ean])
}

model SupplierProductPricing {
  id                  String   @id @default(cuid())
  supplier            String
  sku                 String
  currency            String   @default("GBP")
  costPrice           Decimal? @db.Decimal(12, 2)
  tradePrice          Decimal? @db.Decimal(12, 2)
  rrp                 Decimal? @db.Decimal(12, 2)
  vatRate             Decimal? @db.Decimal(5, 2)
  stockQty            Int?
  availabilityStatus  String?  @db.Text
  leadTimeDays        Int?
  discontinued        Boolean?
  updatedAt           DateTime @updatedAt

  @@unique([supplier, sku])
  @@index([supplier])
}
